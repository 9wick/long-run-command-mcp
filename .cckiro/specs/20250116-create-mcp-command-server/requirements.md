# MCPコマンド実行サーバー 要件定義書

## 概要

AIアシスタントが事前定義されたコマンドを実行できるMCP（Model Context Protocol）サーバーを構築します。このサーバーは、作業ディレクトリとコマンドの組み合わせにキーを付けて事前に設定し、AIアシスタントはそのキーを指定してコマンドを実行します。

## 要件

### 1. キー指定コマンド実行機能

**ユーザーストーリー**
- AIアシスタントとして、事前定義されたキーでコマンドを実行したい
- キーを指定するだけで、設定された作業ディレクトリとコマンドの組み合わせを実行したい
- 実行結果（標準出力・標準エラー出力）を取得したい
- コマンドの実行ステータス（成功/失敗）を確認したい

**受け入れ条件**
- MCPプロトコルに準拠したコマンド実行機能が提供される
- 設定ファイルに定義されたキーに対応するコマンドのみ実行できる
- キーを指定すると、対応する作業ディレクトリでコマンドが実行される
- 存在しないキーを指定した場合はエラーを返す
- 標準出力と標準エラー出力をファイルに保存し、ファイルパスを返す
- ログファイル名は `{config.outputdir}/{unixtimestamp}-{key}-output.log` と `{config.outputdir}/{unixtimestamp}-{key}-error.log` 形式
- コマンドの終了コードを取得できる

### 2. MCPサーバーとしての基本機能

**ユーザーストーリー**
- AIアシスタントとして、MCPプロトコルを通じてサーバーと通信したい
- 利用可能なツール（コマンド実行機能）を発見したい

**受け入れ条件**
- MCPプロトコルに準拠したサーバーが起動する
- ツールの一覧（コマンド実行機能）を提供する
- 適切なエラーハンドリングが実装される

### 3. コマンド設定管理機能

**ユーザーストーリー**
- システム管理者として、キー付きコマンドを設定ファイルで管理したい
- 各コマンドに作業ディレクトリとコマンド内容を定義したい
- ログ出力先ディレクトリを設定したい
- わかりやすいキーを付けて管理したい

**受け入れ条件**
- 設定ファイル（JSON/YAML等）でキー付きコマンドを定義できる
- キーをプロパティ名として、値に「作業ディレクトリ」「コマンド」を設定できる
- グローバル設定として「ログ出力ディレクトリ（outputdir）」を設定できる
- 設定ファイルの検証機能がある（必須項目のチェック等）

### 4. セキュリティ考慮事項

**ユーザーストーリー**
- システム管理者として、安全にコマンドを実行したい

**受け入れ条件**
- 事前定義されたコマンドのみ実行可能（動的なコマンド生成は不可）
- 実行ログを記録する機能を持つ
- 作業ディレクトリの移動は設定された範囲内のみ

## 外部から見たときの振る舞い

### AIアシスタントが利用時に意識すること

1. **接続方法**
   - MCPプロトコルに従ってサーバーに接続する
   - サーバーのアドレスとポートを指定して接続する

2. **コマンド実行の流れ**
   - ツール一覧を取得して利用可能なコマンドキーを確認する
   - コマンド実行ツールを呼び出し、実行したいコマンドのキーを指定する
   - サーバーは設定ファイルから対応する作業ディレクトリとコマンドを取得する
   - 指定されたディレクトリに移動してコマンドを実行する
   - 実行結果をログファイルに保存する
   - レスポンスとして、ログファイルのパス（output/error）と終了コードを受け取る
   - 存在しないキーを指定した場合、エラーメッセージを受け取る

3. **エラーハンドリング**
   - コマンドが失敗した場合、エラーメッセージと終了コードを確認する
   - サーバーとの通信エラーが発生した場合、適切に対処する

### 利用例

```
# AIアシスタントがMCPサーバーを通じてキー指定でコマンドを実行
1. サーバーに接続
2. "list_project_files" というキーでコマンドを実行リクエスト
3. レスポンス:
   - outputPath: "/logs/1705397123-list_project_files-output.log"
   - errorPath: "/logs/1705397123-list_project_files-error.log"
   - exitCode: 0
4. "build_frontend" というキーでコマンドを実行リクエスト
5. レスポンス:
   - outputPath: "/logs/1705397456-build_frontend-output.log"
   - errorPath: "/logs/1705397456-build_frontend-error.log"
   - exitCode: 0
6. 存在しないキー（例："delete_all"）を指定した場合
   → エラー：「指定されたキーのコマンドは存在しません」
```

### コマンド設定例

```json
{
  "outputdir": "/var/log/mcp-commands",
  "commands": {
    "list_project_files": {
      "workdir": "/home/user/project",
      "command": "ls -la"
    },
    "build_frontend": {
      "workdir": "/home/user/project/frontend",
      "command": "npm run build"
    },
    "test_backend": {
      "workdir": "/home/user/project/backend",
      "command": "pytest tests/"
    },
    "check_logs": {
      "workdir": "/var/log",
      "command": "tail -n 100 app.log"
    }
  }
}
```

---

この要件ファイルに問題がないか確認してください。修正が必要な点があればお知らせください。
